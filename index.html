<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TSPi Action - 泰山派运动相机</title>
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/leaflet/1.7.1/leaflet.min.css"/>
    <style>
        :root {
            --primary-color: #2196F3;
            --secondary-color: #607D8B;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 1.5rem;
            background: linear-gradient(145deg, #1a1a1a, #2d2d2d);
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
        }

        .main-title {
            color: #e0e0e0;
            font-size: 2.8em;
            margin: 0;
            font-family: 'Helvetica Neue', sans-serif;
            letter-spacing: 2px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            position: relative;
            display: inline-block;
        }

        .main-title::after {
            content: '';
            display: block;
            width: 60%;
            height: 2px;
            background: #5a5a5a;
            margin: 12px auto 0;
            opacity: 0.8;
        }

        .author {
            color: #909090;
            font-size: 0.9em;
            margin-top: 15px;
            letter-spacing: 1px;
            font-family: 'Courier New', monospace;
        }

        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }

        .tab-nav {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 2px solid var(--secondary-color);
        }

        .tab-btn {
            padding: 12px 24px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
        }

        .tab-btn.active {
            background-color: var(--primary-color);
            color: white;
        }

        .device-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            padding: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .info-card {
            padding: 20px;
            border-left: 4px solid var(--primary-color);
            background: #f8f9fa;
        }

        .info-card h3 {
            color: var(--secondary-color);
            margin: 0 0 10px 0;
        }

        .video-manager {
            display: none;
            background: white;
            border-radius: 8px;
            padding: 20px;
        }

        .file-list {
            max-height: 60vh;
            overflow-y: auto;
        }

        .file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background 0.2s;
        }

        .file-item:hover {
            background: #f8f9fa;
        }

        .video-detail {
            display: none;
        }

        #video-player {
            width: 100%;
            height: 400px;
            background: #000;
            border-radius: 8px;
        }

        #map-container {
            height: 400px;
            margin-top: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }

        .example-badge {
            background: #4CAF50;
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.8em;
            margin-left: 8px;
        }

        .detail-actions {
            margin: 20px 0;
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            background: var(--primary-color);
            color: white;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1 class="main-title">TSPi Action 泰山派运动相机</h1>
        <div class="author">Developed by GitHub@LegionMay</div>
    </div>

    <div class="tab-nav">
        <button class="tab-btn active" onclick="showTab('device')">设备信息</button>
        <button class="tab-btn" onclick="showTab('video')">视频管理</button>
    </div>

    <!-- 设备信息页 -->
    <div id="deviceTab" class="device-info">
        <div class="info-card">
            <h3>处理器</h3>
            <p>RK3566<br>四核ARM Cortex A55 @ 2.0GHz</p>
        </div>
        <div class="info-card">
            <h3>电源信息</h3>
            <p>1000mAh 锂离子聚合物电池</p>
        </div>
        <div class="info-card">
            <h3>存储配置</h3>
            <p>RAM：2GB LPDDR4<br>ROM：16GB eMMC</p>
        </div>
        <div class="info-card">
            <h3>系统版本</h3>
            <p>Firmware v1.0.0<br>Build 20240320</p>
        </div>
    </div>

    <!-- 视频管理页 -->
    <div id="videoTab" class="video-manager">
        <div class="file-list" id="fileList"></div>

        <div class="video-detail">
            <video id="video-player" controls></video>
            <div class="detail-actions">
                <a id="downloadBtn" class="btn" download>下载视频</a>
                <button class="btn" onclick="backToList()">返回列表</button>
            </div>
            <div id="map-container"></div>
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://cdn.bootcdn.net/ajax/libs/leaflet/1.7.1/leaflet.min.js"></script>
    <script>
        // 全局状态管理
        const AppState = {
            currentTab: 'device',
            mapInstance: null,
            fileListLoaded: false,
            exampleData: {
                video: {
                    name: "示例视频.mp4",
                    path: "data:video/mp4;base64,AAAAIGZ0eXBpc29tAAACAGlzb21pc28yYXZjMW1wNDEAAAAIZnJlZQAABNttZGF0AAAAL...",
                    size: 5242880,
                    date: "2024-03-20 14:30",
                    isExample: true
                },
                gnss: {
                    timestamp: "1710927000",
                    latitude: 39.9042,
                    longitude: 116.4074,
                    satellites: 8,
                    altitude: 52.3,
                    record_time: "20240320_143000"
                }
            }
        };

        // 选项卡切换
        function showTab(tab) {
            AppState.currentTab = tab;
            document.getElementById('deviceTab').style.display = tab === 'device' ? 'grid' : 'none';
            document.getElementById('videoTab').style.display = tab === 'video' ? 'block' : 'none';
            
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.toggle('active', btn.textContent.trim() === (tab === 'device' ? '设备信息' : '视频管理'));
            });

            if(tab === 'video' && !AppState.fileListLoaded) {
                loadVideoFiles();
                AppState.fileListLoaded = true;
            }
        }

        // 优化版文件加载函数
        async function loadVideoFiles() {
            try {
                const startTime = performance.now();
                // 修改请求路径为 /mnt/sdcard
                const response = await fetch('/mnt/sdcard/');
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status} ${response.statusText}`);
                }

                const html = await response.text();
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                
                // 精确解析表格结构
                const fileItems = Array.from(doc.querySelectorAll('tr'))
                    .slice(1)
                    .map(tr => {
                        const tds = tr.querySelectorAll('td');
                        if (tds.length < 3) return null;
                        
                        const link = tds[0].querySelector('a');
                        if (!link || !link.href) return null;

                        // 提取完整路径（解析相对路径）
                        const path = new URL(link.href, window.location.href).pathname;
                        
                        return {
                            name: link.textContent.trim(),
                            path: path,
                            size: parseInt(tds[1].textContent.replace(/[^0-9]/g, '')) || 0,
                            date: tds[2].textContent.trim(),
                            isExample: false
                        };
                    })
                    .filter(file => {
                        return file && 
                            /\.(mkv|mp4)$/i.test(file.name) &&
                            file.size > 1024; // 过滤无效文件
                    });

                console.log(`加载完成，耗时：${(performance.now() - startTime).toFixed(1)}ms`);
                renderFileList(fileItems.length > 0 ? fileItems : [AppState.exampleData.video]);
            } catch (error) {
                console.error('文件加载失败:', error);
                renderFileList([AppState.exampleData.video]);
            }
        }
        
        // 优化渲染性能
        function renderFileList(files) {
            const container = document.getElementById('fileList');
            const fragment = document.createDocumentFragment();
            
            files.forEach(file => {
                const item = document.createElement('div');
                item.className = 'file-item';
                item.innerHTML = `
                    <span>
                        ${escapeHTML(file.name)}
                        ${file.isExample ? '<span class="example-badge">示例</span>' : ''}
                    </span>
                    <span>${formatSize(file.size)}</span>
                    <span>${escapeHTML(file.date)}</span>
                `;
                item.dataset.filePath = encodeURI(file.path);
                fragment.appendChild(item);
            });

            // 使用事件委托
            container.replaceChildren(fragment);
            container.addEventListener('click', handleFileClick);
        }

        // 文件点击处理
        function handleFileClick(event) {
            const item = event.target.closest('.file-item');
            if (item) {
                const file = {
                    name: decodeURI(item.dataset.filePath.split('/').pop()),
                    path: decodeURI(item.dataset.filePath),
                    size: parseInt(item.children[1].textContent.match(/(\d+\.?\d*)/)[0]),
                    date: item.children[2].textContent,
                    isExample: item.querySelector('.example-badge') !== null
                };
                showVideoDetail(file);
            }
        }

        // 显示视频详情
        async function showVideoDetail(file) {
            document.querySelector('.file-list').style.display = 'none';
            document.querySelector('.video-detail').style.display = 'block';

            const player = document.getElementById('video-player');
            try {
                player.src = file.isExample ? AppState.exampleData.video.path : file.path;
                await player.play().catch(() => {}); // 自动播放处理
                
                // 异步加载地图
                const coords = await loadGPSData(
                    file.name.replace(/\.[^.]+$/, '') + '.json'
                );
                initMap(coords);
            } catch (error) {
                console.error('视频初始化失败:', error);
                player.src = '';
                alert('视频加载失败，请检查文件格式和权限');
            }

            // 下载按钮处理
            const downloadBtn = document.getElementById('downloadBtn');
            if (file.isExample) {
                downloadBtn.href = "#";
                downloadBtn.onclick = () => alert('示例文件不支持下载');
            } else {
                downloadBtn.href = file.path;
                downloadBtn.download = file.name;
                downloadBtn.onclick = null;
            }
        }

        // 地图初始化（高德+腾讯双方案）
        function initMap(coords) {
            if (AppState.mapInstance) {
                AppState.mapInstance.remove();
            }

            AppState.mapInstance = L.map('map-container', {
                center: [coords.latitude, coords.longitude],
                zoom: 15,
                attributionControl: false
            });

            // 高德地图层
            const amapLayer = L.tileLayer(
                'https://webrd0{s}.is.autonavi.com/appmaptile?lang=zh_cn&size=1&scale=1&style=8&x={x}&y={y}&z={z}', {
                    subdomains: ['1', '2', '3', '4'],
                    maxZoom: 19,
                    tileSize: 256,
                    detectRetina: true
                }
            );

            // 腾讯备用层
            const tencentLayer = L.tileLayer(
                'https://rt{s}.map.gtimg.com/realtimerender?z={z}&x={x}&y={y}&type=vector&style=6', {
                    subdomains: ['0', '1', '2', '3'],
                    maxZoom: 19
                }
            );

            // 自动切换逻辑
            amapLayer.addTo(AppState.mapInstance).on('tileerror', () => {
                amapLayer.remove();
                tencentLayer.addTo(AppState.mapInstance);
                console.warn('已切换备用地图源');
            });

            // 标记点
            L.marker([coords.latitude, coords.longitude])
                .bindPopup(createPopupContent(coords))
                .addTo(AppState.mapInstance);
        }

        // 工具函数
        function escapeHTML(str) {
            return str.replace(/&/g, '&amp;')
                     .replace(/</g, '&lt;')
                     .replace(/>/g, '&gt;')
                     .replace(/"/g, '&quot;')
                     .replace(/'/g, '&#039;');
        }

        function formatSize(bytes) {
            const units = ['B', 'KB', 'MB', 'GB'];
            let i = 0;
            while (bytes >= 1024 && i < units.length - 1) {
                bytes /= 1024;
                i++;
            }
            return `${bytes.toFixed(i > 0 ? 2 : 0)} ${units[i]}`;
        }

        function formatTime(timeStr) {
            return timeStr.replace(
                /(\d{4})(\d{2})(\d{2})_(\d{2})(\d{2})(\d{2})/,
                '$1-$2-$3 $4:$5:$6'
            );
        }

        function createPopupContent(coords) {
            return `
                <b>记录时间:</b> ${formatTime(coords.record_time)}<br>
                <b>坐标:</b> ${coords.latitude.toFixed(6)}, ${coords.longitude.toFixed(6)}<br>
                <b>海拔:</b> ${coords.altitude}m<br>
                <b>卫星数:</b> ${coords.satellites}
            `;
        }

        function backToList() {
            document.querySelector('.file-list').style.display = 'block';
            document.querySelector('.video-detail').style.display = 'none';
            if (AppState.mapInstance) {
                AppState.mapInstance.remove();
                AppState.mapInstance = null;
            }
        }

        // 初始化
        showTab('device');
    </script>
</body>
</html>    
