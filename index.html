<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TSPi Action - 泰山派运动相机</title>
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/leaflet/1.7.1/leaflet.min.css"/>
    <style>
        :root {
            --primary-color: #2196F3;
            --secondary-color: #607D8B;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 1.5rem;
            background: linear-gradient(145deg, #1a1a1a, #2d2d2d);
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
        }

        .main-title {
            color: #e0e0e0;
            font-size: 2.8em;
            margin: 0;
            font-family: 'Helvetica Neue', sans-serif;
            letter-spacing: 2px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            position: relative;
            display: inline-block;
        }

        .main-title::after {
            content: '';
            display: block;
            width: 60%;
            height: 2px;
            background: #5a5a5a;
            margin: 12px auto 0;
            opacity: 0.8;
        }

        .author {
            color: #909090;
            font-size: 0.9em;
            margin-top: 15px;
            letter-spacing: 1px;
            font-family: 'Courier New', monospace;
        }

        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }

        .tab-nav {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 2px solid var(--secondary-color);
        }

        .tab-btn {
            padding: 12px 24px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
        }

        .tab-btn.active {
            background-color: var(--primary-color);
            color: white;
        }

        .device-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            padding: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .info-card {
            padding: 20px;
            border-left: 4px solid var(--primary-color);
            background: #f8f9fa;
        }

        .info-card h3 {
            color: var(--secondary-color);
            margin: 0 0 10px 0;
        }

        .video-manager {
            display: none;
            background: white;
            border-radius: 8px;
            padding: 20px;
        }

        .file-list {
            max-height: 60vh;
            overflow-y: auto;
        }

        .file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background 0.2s;
        }

        .file-item:hover {
            background: #f8f9fa;
        }

        .video-detail {
            display: none;
        }

        #video-player {
            width: 100%;
            height: 400px;
            background: #000;
            border-radius: 8px;
        }

        #map-container {
            height: 400px;
            margin-top: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }

        .example-badge {
            background: #4CAF50;
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.8em;
            margin-left: 8px;
        }

        .detail-actions {
            margin: 20px 0;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            background: var(--primary-color);
            color: white;
            text-decoration: none;
        }
        
        .btn-secondary {
            background: var(--secondary-color);
        }
        
        .btn-warning {
            background: #FF9800;
        }
        
        .loading-indicator {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            color: var(--secondary-color);
        }
        
        .alert {
            padding: 10px 15px;
            margin: 10px 0;
            border-radius: 4px;
            color: white;
        }
        
        .alert-info {
            background-color: var(--primary-color);
        }
        
        .alert-warning {
            background-color: #FF9800;
        }
        
        .alert-error {
            background-color: #F44336;
        }
        
        .data-section {
            margin-top: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 4px;
        }
        
        .data-section h3 {
            margin-top: 0;
            color: var(--secondary-color);
        }
        
        .data-preview {
            max-height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
            padding: 10px;
            background-color: #f0f0f0;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1 class="main-title">TSPi Action 泰山派运动相机</h1>
        <div class="author">Developed by GitHub@LegionMay</div>
    </div>

    <div class="tab-nav">
        <button class="tab-btn active" onclick="showTab('device')">设备信息</button>
        <button class="tab-btn" onclick="showTab('video')">视频管理</button>
    </div>

    <!-- 设备信息页 -->
    <div id="deviceTab" class="device-info">
        <div class="info-card">
            <h3>处理器</h3>
            <p>RK3566<br>四核ARM Cortex A55 @ 2.0GHz</p>
        </div>
        <div class="info-card">
            <h3>电源信息</h3>
            <p>1000mAh 锂离子聚合物电池</p>
        </div>
        <div class="info-card">
            <h3>存储配置</h3>
            <p>RAM：2GB LPDDR4<br>ROM：16GB eMMC</p>
        </div>
        <div class="info-card">
            <h3>系统版本</h3>
            <p>Firmware v1.0.0<br>Build 20240320</p>
        </div>
    </div>

    <!-- 视频管理页 -->
    <div id="videoTab" class="video-manager">
        <div class="file-list" id="fileList">
            <div class="loading-indicator">加载文件列表中...</div>
        </div>

        <div class="video-detail">
            <video id="video-player" controls playsinline></video>
            <div id="video-error" class="alert alert-error" style="display: none;"></div>
            
            <div class="detail-actions">
                <a id="downloadVideoBtn" class="btn" download>下载视频</a>
                <a id="downloadGnssBtn" class="btn btn-secondary" download>下载GNSS数据</a>
                <a id="downloadImuBtn" class="btn btn-secondary" download>下载IMU数据</a>
                <button class="btn btn-warning" onclick="backToList()">返回列表</button>
            </div>
            
            <!-- 数据预览部分 -->
            <div class="data-section">
                <h3>GNSS数据预览</h3>
                <div id="gnss-info" class="alert alert-info">加载GNSS数据中...</div>
                <div id="map-container"></div>
            </div>
            
            <div class="data-section">
                <h3>IMU数据预览</h3>
                <div id="imu-info" class="alert alert-info">加载IMU数据中...</div>
                <div id="imu-preview" class="data-preview"></div>
            </div>
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://cdn.bootcdn.net/ajax/libs/leaflet/1.7.1/leaflet.min.js"></script>
    <script>
        // 全局状态管理
        const AppState = {
            currentTab: 'device',
            mapInstance: null,
            fileListLoaded: false,
            currentFile: null,
            exampleData: {
                video: {
                    name: "record_20240320_143000.mkv",
                    path: "data:video/mp4;base64,AAAAIGZ0eXBpc29tAAACAGlzb21pc28yYXZjMW1wNDEAAAAIZnJlZQAABNttZGF0AAAAL...",
                    size: 5242880,
                    date: "2024-03-20 14:30",
                    isExample: true
                },
                gnss: {
                    data: [
                        {
                            timestamp: "1710927000",
                            coords: [39.9042, 116.4074],
                            altitude: 52.3,
                            satellites: 8,
                            record_time: "20240320_143000",
                            status: "active"
                        }
                    ]
                },
                imu: "Timestamp,Roll(deg),Pitch(deg),Yaw(deg)\n1744209604.000000000,0.00,0.00,0.00\n1744209609.330381295,-1.89,-8.42,-169.35"
            }
        };

        // 选项卡切换
        function showTab(tab) {
            AppState.currentTab = tab;
            document.getElementById('deviceTab').style.display = tab === 'device' ? 'grid' : 'none';
            document.getElementById('videoTab').style.display = tab === 'video' ? 'block' : 'none';
            
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.toggle('active', btn.textContent.trim() === (tab === 'device' ? '设备信息' : '视频管理'));
            });

            if(tab === 'video' && !AppState.fileListLoaded) {
                loadVideoFiles();
                AppState.fileListLoaded = true;
            }
        }

        // 优化版文件加载函数
        async function loadVideoFiles() {
            try {
                document.getElementById('fileList').innerHTML = '<div class="loading-indicator">加载文件列表中...</div>';
                
                const startTime = performance.now();
                const response = await fetch('/');
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status} ${response.statusText}`);
                }

                const html = await response.text();
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                
                // 解析表格结构，专注于匹配record_*.mkv格式
                const videoRegex = /^record_\d{8}_\d{6}\.mkv$/;
                
                const fileItems = Array.from(doc.querySelectorAll('tr'))
                    .slice(1)
                    .map(tr => {
                        const tds = tr.querySelectorAll('td');
                        if (tds.length < 3) return null;
                        
                        const link = tds[0].querySelector('a');
                        if (!link || !link.href) return null;

                        const fileName = link.textContent.trim();
                        if (!videoRegex.test(fileName)) return null;
                        
                        // 提取完整路径
                        const path = new URL(link.href, window.location.href).pathname;
                        
                        // 提取基本名称用于关联文件
                        const baseName = fileName.replace(/\.mkv$/, '');
                        
                        return {
                            name: fileName,
                            path: path,
                            baseName: baseName,
                            size: parseInt(tds[1].textContent.replace(/[^0-9]/g, '')) || 0,
                            date: tds[2].textContent.trim(),
                            isExample: false
                        };
                    })
                    .filter(file => file !== null);

                console.log(`加载完成，找到${fileItems.length}个视频文件，耗时：${(performance.now() - startTime).toFixed(1)}ms`);
                
                if (fileItems.length > 0) {
                    renderFileList(fileItems);
                } else {
                    document.getElementById('fileList').innerHTML = '<div class="alert alert-warning">未找到符合格式的视频文件 (record_YYYYMMDD_HHMMSS.mkv)</div>';
                }
            } catch (error) {
                console.error('文件加载失败:', error);
                document.getElementById('fileList').innerHTML = `<div class="alert alert-error">文件加载失败: ${error.message}</div>`;
            }
        }
        
        // 优化渲染性能
        function renderFileList(files) {
            const container = document.getElementById('fileList');
            const fragment = document.createDocumentFragment();
            
            files.forEach(file => {
                const item = document.createElement('div');
                item.className = 'file-item';
                
                // 从文件名提取日期时间并格式化
                let displayDate = file.date;
                const dateMatch = file.baseName.match(/record_(\d{4})(\d{2})(\d{2})_(\d{2})(\d{2})(\d{2})/);
                if (dateMatch) {
                    displayDate = `${dateMatch[1]}-${dateMatch[2]}-${dateMatch[3]} ${dateMatch[4]}:${dateMatch[5]}:${dateMatch[6]}`;
                }
                
                item.innerHTML = `
                    <span>
                        ${escapeHTML(file.name)}
                        ${file.isExample ? '<span class="example-badge">示例</span>' : ''}
                    </span>
                    <span>${formatSize(file.size)}</span>
                    <span>${escapeHTML(displayDate)}</span>
                `;
                
                item.dataset.filePath = encodeURI(file.path);
                item.dataset.baseName = file.baseName;
                fragment.appendChild(item);
            });

            // 使用事件委托
            container.innerHTML = '';
            container.appendChild(fragment);
            container.addEventListener('click', handleFileClick);
        }

        // 文件点击处理
        function handleFileClick(event) {
            const item = event.target.closest('.file-item');
            if (item) {
                const filePath = decodeURI(item.dataset.filePath);
                const fileName = filePath.split('/').pop();
                const baseName = item.dataset.baseName;
                
                const file = {
                    name: fileName,
                    path: filePath,
                    baseName: baseName,
                    size: parseInt(item.children[1].textContent.match(/(\d+\.?\d*)/)[0]),
                    date: item.children[2].textContent,
                    isExample: false
                };
                
                AppState.currentFile = file;
                showVideoDetail(file);
            }
        }

        // 显示视频详情
        async function showVideoDetail(file) {
            document.querySelector('.file-list').style.display = 'none';
            document.querySelector('.video-detail').style.display = 'block';
            
            const videoPlayer = document.getElementById('video-player');
            const videoError = document.getElementById('video-error');
            const gnssInfo = document.getElementById('gnss-info');
            const imuInfo = document.getElementById('imu-info');
            const imuPreview = document.getElementById('imu-preview');
            
            // 重置显示
            videoError.style.display = 'none';
            videoPlayer.style.display = 'block';
            gnssInfo.textContent = '加载GNSS数据中...';
            imuInfo.textContent = '加载IMU数据中...';
            imuPreview.textContent = '';

            try {
                // 设置视频源
                videoPlayer.src = file.path;
                
                // 添加视频错误处理
                videoPlayer.onerror = function() {
                    console.error(`视频加载错误: ${videoPlayer.error.code}: ${videoPlayer.error.message}`);
                    videoError.textContent = `视频无法播放: ${getVideoErrorMessage(videoPlayer.error.code)}`;
                    videoError.style.display = 'block';
                    videoPlayer.style.display = 'none';
                };
                
                // 准备下载按钮
                prepareDownloadButtons(file);
                
                // 异步加载GNSS和IMU数据
                loadGNSSData(file)
                    .then(gnssData => {
                        if (gnssData && gnssData.data && gnssData.data.length > 0) {
                            const lastEntry = gnssData.data[gnssData.data.length - 1];
                            gnssInfo.textContent = `GNSS坐标: ${lastEntry.coords[0].toFixed(6)}, ${lastEntry.coords[1].toFixed(6)} | 卫星数: ${lastEntry.satellites} | 海拔: ${lastEntry.altitude}米`;
                            
                            // 初始化地图
                            initMap({
                                latitude: lastEntry.coords[0],
                                longitude: lastEntry.coords[1],
                                satellites: lastEntry.satellites,
                                altitude: lastEntry.altitude,
                                record_time: lastEntry.record_time || file.baseName.replace('record_', '')
                            });
                        } else {
                            throw new Error('GNSS数据格式无效或为空');
                        }
                    })
                    .catch(err => {
                        console.warn('GNSS数据加载失败:', err);
                        gnssInfo.textContent = '未能加载GNSS数据，使用默认坐标';
                        
                        // 使用默认坐标
                        initMap({
                            latitude: 36.2048,   // 泰山默认坐标
                            longitude: 117.1234,
                            satellites: 0,
                            altitude: 0,
                            record_time: file.baseName.replace('record_', '')
                        });
                    });
                
                loadIMUData(file)
                    .then(imuData => {
                        if (imuData) {
                            const lines = imuData.split('\n');
                            if (lines.length > 1) {
                                // 计算IMU数据简单统计
                                const dataLines = lines.slice(1); // 跳过标题行
                                const count = dataLines.length;
                                
                                imuInfo.textContent = `IMU数据: ${count}条记录`;
                                
                                // 显示前10行
                                const previewLines = lines.slice(0, 10);
                                imuPreview.textContent = previewLines.join('\n') + (lines.length > 10 ? '\n...' : '');
                            } else {
                                imuInfo.textContent = 'IMU数据格式无效或为空';
                            }
                        } else {
                            throw new Error('IMU数据为空');
                        }
                    })
                    .catch(err => {
                        console.warn('IMU数据加载失败:', err);
                        imuInfo.textContent = '未能加载IMU数据';
                        imuPreview.textContent = '数据不可用';
                    });
                
            } catch (error) {
                console.error('视频初始化失败:', error);
                videoError.textContent = `视频加载失败: ${error.message}`;
                videoError.style.display = 'block';
                videoPlayer.style.display = 'none';
            }
        }
        
        // 准备下载按钮
        function prepareDownloadButtons(file) {
            const basePath = file.path.substring(0, file.path.lastIndexOf('/') + 1);
            const gnssPath = `${basePath}gnss_${file.baseName.substring(7)}.json`;
            const imuPath = `${basePath}imu_${file.baseName.substring(7)}.csv`;
            
            // 设置下载按钮
            document.getElementById('downloadVideoBtn').href = file.path;
            document.getElementById('downloadVideoBtn').download = file.name;
            
            document.getElementById('downloadGnssBtn').href = gnssPath;
            document.getElementById('downloadGnssBtn').download = gnssPath.split('/').pop();
            
            document.getElementById('downloadImuBtn').href = imuPath;
            document.getElementById('downloadImuBtn').download = imuPath.split('/').pop();
            
            console.log('设置下载路径:', {video: file.path, gnss: gnssPath, imu: imuPath});
        }
        
        // 加载GNSS数据
        async function loadGNSSData(file) {
            if (file.isExample) {
                return AppState.exampleData.gnss;
            }
            
            const basePath = file.path.substring(0, file.path.lastIndexOf('/') + 1);
            const gnssPath = `${basePath}gnss_${file.baseName.substring(7)}.json`;
            
            console.log('尝试加载GNSS数据:', gnssPath);
            
            try {
                const response = await fetch(gnssPath);
                if (!response.ok) {
                    throw new Error(`加载GNSS数据失败: ${response.status}`);
                }
                return await response.json();
            } catch (error) {
                console.error('GNSS数据获取失败:', error);
                throw error;
            }
        }
        
        // 加载IMU数据
        async function loadIMUData(file) {
            if (file.isExample) {
                return AppState.exampleData.imu;
            }
            
            const basePath = file.path.substring(0, file.path.lastIndexOf('/') + 1);
            const imuPath = `${basePath}imu_${file.baseName.substring(7)}.csv`;
            
            console.log('尝试加载IMU数据:', imuPath);
            
            try {
                const response = await fetch(imuPath);
                if (!response.ok) {
                    throw new Error(`加载IMU数据失败: ${response.status}`);
                }
                return await response.text();
            } catch (error) {
                console.error('IMU数据获取失败:', error);
                throw error;
            }
        }

        // 地图初始化（多地图源+错误处理）
        function initMap(coords) {
            console.log('初始化地图，坐标:', coords);
            
            if (AppState.mapInstance) {
                AppState.mapInstance.remove();
                AppState.mapInstance = null;
            }

            try {
                AppState.mapInstance = L.map('map-container', {
                    center: [coords.latitude, coords.longitude],
                    zoom: 13,
                    attributionControl: false
                });

                // 定义多个地图源
                const mapSources = {
                    // 高德地图
                    amap: L.tileLayer(
                        'https://webrd0{s}.is.autonavi.com/appmaptile?lang=zh_cn&size=1&scale=1&style=8&x={x}&y={y}&z={z}', {
                            subdomains: ['1', '2', '3', '4'],
                            maxZoom: 19,
                            tileSize: 256,
                            detectRetina: true
                        }
                    ),
                    // 腾讯地图
                    tencent: L.tileLayer(
                        'https://rt{s}.map.gtimg.com/realtimerender?z={z}&x={x}&y={y}&type=vector&style=6', {
                            subdomains: ['0', '1', '2', '3'],
                            maxZoom: 19
                        }
                    ),
                    // OpenStreetMap备选
                    osm: L.tileLayer(
                        'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                            subdomains: 'abc',
                            maxZoom: 19,
                            attribution: '&copy; OpenStreetMap'
                        }
                    )
                };

                // 首先尝试高德地图
                mapSources.amap.addTo(AppState.mapInstance);
                
                // 地图加载失败时自动切换源
                mapSources.amap.on('tileerror', function() {
                    console.warn('高德地图加载失败，切换到腾讯地图');
                    AppState.mapInstance.removeLayer(mapSources.amap);
                    
                    mapSources.tencent.addTo(AppState.mapInstance);
                    mapSources.tencent.on('tileerror', function() {
                        console.warn('腾讯地图加载失败，切换到OpenStreetMap');
                        AppState.mapInstance.removeLayer(mapSources.tencent);
                        mapSources.osm.addTo(AppState.mapInstance);
                    });
                });

                // 添加标记点
                L.marker([coords.latitude, coords.longitude])
                    .bindPopup(createPopupContent(coords))
                    .addTo(AppState.mapInstance)
                    .openPopup();
                
            } catch (error) {
                console.error('地图初始化失败:', error);
                document.getElementById('map-container').innerHTML = 
                    `<div class="alert alert-error">地图加载失败: ${error.message}</div>`;
            }
        }

        // 获取视频错误信息
        function getVideoErrorMessage(code) {
            switch (code) {
                case MediaError.MEDIA_ERR_ABORTED: 
                    return '播放中断';
                case MediaError.MEDIA_ERR_NETWORK: 
                    return '网络错误';
                case MediaError.MEDIA_ERR_DECODE: 
                    return '解码错误，视频格式可能不受支持';
                case MediaError.MEDIA_ERR_SRC_NOT_SUPPORTED: 
                    return '视频格式不受支持';
                default: 
                    return '未知错误';
            }
        }

        // 工具函数
        function escapeHTML(str) {
            if (!str) return '';
            return str.toString().replace(/&/g, '&amp;')
                     .replace(/</g, '&lt;')
                     .replace(/>/g, '&gt;')
                     .replace(/"/g, '&quot;')
                     .replace(/'/g, '&#039;');
        }

        function formatSize(bytes) {
            const units = ['B', 'KB', 'MB', 'GB'];
            let i = 0;
            while (bytes >= 1024 && i < units.length - 1) {
                bytes /= 1024;
                i++;
            }
            return `${bytes.toFixed(i > 0 ? 2 : 0)} ${units[i]}`;
        }

        function formatTime(timeStr) {
            if (!timeStr) return '未知时间';
            
            const match = timeStr.match(/(\d{4})(\d{2})(\d{2})_(\d{2})(\d{2})(\d{2})/);
            if (match) {
                return `${match[1]}-${match[2]}-${match[3]} ${match[4]}:${match[5]}:${match[6]}`;
            }
            return timeStr;
        }

        function createPopupContent(coords) {
            return `
                <b>记录时间:</b> ${formatTime(coords.record_time)}<br>
                <b>坐标:</b> ${coords.latitude.toFixed(6)}, ${coords.longitude.toFixed(6)}<br>
                <b>海拔:</b> ${coords.altitude}m<br>
                <b>卫星数:</b> ${coords.satellites || 0}
            `;
        }

        function backToList() {
            // 停止当前视频
            const videoPlayer = document.getElementById('video-player');
            videoPlayer.pause();
            videoPlayer.removeAttribute('src');
            videoPlayer.load();
            
            document.querySelector('.file-list').style.display = 'block';
            document.querySelector('.video-detail').style.display = 'none';
            
            // 清理地图
            if (AppState.mapInstance) {
                AppState.mapInstance.remove();
                AppState.mapInstance = null;
            }
        }

        // 初始化
        showTab('device');
    </script>
</body>
</html>